%----------------------------------------------------------------------------
\chapter{Tervezés \label{chapter3}}
%----------------------------------------------------------------------------

Az elméleti megfontolások, alapelvek bemutatását követően ebben a fejezetben rátérek a feladat megoldását adó rendszer struktúrájának, főbb komponenseinek tárgyalására.

\section{A célkitűzés}

A diplomamunka során elkészített rendszernek képesnek kellett lennie egy zárt térrész tetszőlegesen választott pontjában és irányában látható, a mozgó objektumokat tartalmazó kép helyreállítására fix telepítésű kamerák valós idejű videofolyamai alapján. A helyreállítást akkor tekintettem sikeresnek, ha a mozgó objektumokat detektáltam és választott nézőpontból azok megközelítő kontúrjait sikeresen meghatároztam. A tényleges objektum struktúrájának illetve textúrájának meghatározása nem esett a dolgozat hatáskörébe. A választott nézőpontra is voltak korlátaink, érdemi rekonstrukciót csak a kamerákat összekötő képzeletbeli szakaszon és annak környezetében várhatunk, így a tesztelést is így végeztem.

A rendszer tervezése során figyelembe vettem, hogy lényegében tetszőleges számú kamerát is felhasználhattam a probléma megoldásához, ennek megfelelően a megvalósított rendszer architektúráját így készítettem el, de az elérhető eszközök korlátozott száma miatt csak két kamerával teszteltem.

Egyre több kamera bevonásával a rekonstrukció minősége, valamint a helyesen rekonstruálható nézőpontok száma növekszik, de ezzel együtt a rendszer teljesítménye a megnövekedő számítási szükséglet miatt csökken. Fontos megemlíteni, hogy a feladat és a megoldás jellegéből adódóan a független kamerákból meghatározott rekonstrukciók párhuzamosíthatóak, így ezek megfelelő feldolgozó egységet feltételezve egy időben elvégezhetőek. Ez azt jelenti, hogy a kamerák számának növelése valóban megoldás lehet a robusztusabb eredmény eléréséhez.

\section{Keretrendszer}

A diplomamunka során az OpenCV \cite{opencv} keretrendszert használtam, melynek célja, hogy a fejlesztőknek egy szabadon és ingyenes elérhető alkalmazás-könyvtárat biztosítson a gépi látás területén elterjedt és gyakran használt algoritmusokhoz. Több nyelvhez is biztosít API-t, én ezek közül a C++-os interfészét alkalmaztam, a lehető legnagyobb teljesítmény elérése érdekében. Az OpenCV-t már az előző félévekben megismertem, így a diplomamunka során már eredményesen tudtam építkezni az általa nyújtott funkciókra.

\section{A tervezett rendszer működése}

A feladat megoldásához \aref{methods:optic}. részben leírt optikai folyam alapú eljárást használtam fel. A rendszer tervét, átfogó képét a következőkben mutatom be.

A kamerákat két lépésben kalibráltam; először, hogy a torzításukat minimalizáljam, majd azért, hogy meghatározhassam az elhelyezkedésüket egy rögzített koordinátarendszerben.

Ezt követően a kamerák képeiből meghatároztam az előtér maszkot. Erre kétféle megközelítést is implementáltam; az egyik az optikai folyamokat használja a mozgás érzékeléséhez, ami kijelöli az előteret, a másik pedig egy előtér-háttér szegmentációs eljárás. Ezek közül összehasonlítás után választottam, lásd a következő fejezet.

Miután a vélt előtér objektumok maszkjait meghatároztam, ezeket a képeken egymással párosítottam. Itt is kétféle megközelítést próbáltam ki és implementáltam. Az első egy egyszerű ,,legnagyobb-területű'' kiválasztás, amely mindkét képen a legnagyobb területű \textit{blob}ot (egy objektumhoz tartozó egybefüggő képterület) keresi, és ezeket felelteti meg egymásnak. Természetesen ilyenkor csak egy objektumot tudunk rekonstruálni, de a további lépéseket jól lehet rajta tesztelni. A másik eljárás pedig, hogy ezen a blobokon jellegzetes pontokat kerestem, és megpróbáltam egymásnak megfeleltetni őket. Ezekből a megfeleltetések alapján többségi döntést alkalmazva határoztam meg, hogy az egyik kép blobja melyik másik blobnak felel meg.

A blob-párosítások alapján, külön-külön optikai folyamokkal sűrű pont-pont megfeleltetést számoltam a két képen. Felhasználva, hogy a kamerák helyzetét ismertem, háromszögeléssel megkaptam a pontok világbeli koordinátáit.

Végül a választott nézőpontból projekció segítségével meghatároztam az onnan látható becsült képet (felhasználva az eredeti képből kinyerhető színinformációkat), valamint az objektumokhoz tartozó kontúrokat.

\begin{sidewaysfigure}
\centering

\pgfdeclarelayer{background}
\pgfdeclarelayer{foreground}
\pgfsetlayers{background,main,foreground}

\resizebox{\textwidth}{!}{%
\begin{tikzpicture}[->,>=stealth',shorten >=1pt,auto]
\tikzset{
box/.style={draw, rectangle, text width=12em, minimum height=2.5em, text centered},
plain/.style={text width=12em, text centered},
line/.style = {-,shorten >=0pt},
graybox/.style = {box, gray}
}

\node[plain] (Cam1) {1. kamera};

\node[graybox,fill=green!10] (Calib1) [below of=Cam1] {Kalibrálás};

\node[box,fill=green!10] (GetFrames1) [below of=Calib1,yshift=-1.5em] {Aktuális képkocka lekérése};

\node[box,fill=green!10] (OD1) [below of=GetFrames1,yshift=-1.5em] {Objektum(ok) detektálása};

\draw (Calib1) -- (GetFrames1);
\draw (GetFrames1) -- (OD1);



\node[plain] (Cam2) [right of=Cam1,xshift=14em] {2. kamera};

\node[graybox,fill=green!10] (Calib2) [below of=Cam2] {Kalibrálás};

\node[box,fill=green!10] (GetFrames2) [below of=Calib2,yshift=-1.5em] {Aktuális képkocka lekérése};

\node[box,fill=green!10] (OD2) [below of=GetFrames2,yshift=-1.5em] {Objektum(ok) detektálása};

\draw (Calib2) -- (GetFrames2);
\draw (GetFrames2) -- (OD2);



\node[plain] (Cam3) [right of=Cam2,xshift=14em] {3. kamera};

\node[graybox] (Calib3) [below of=Cam3] {Kalibrálás};

\node[box] (GetFrames3) [below of=Calib3,yshift=-1.5em] {Aktuális képkocka lekérése};

\node[box] (OD3) [below of=GetFrames3,yshift=-1.5em] {Objektum(ok) detektálása};

\draw (Calib3) -- (GetFrames3);
\draw (GetFrames3) -- (OD3);



\node[plain] (CamN) [right of=Cam3,xshift=18em] {$n$. kamera};

\node[graybox] (CalibN) [below of=CamN] {Kalibrálás};

\node[box] (GetFramesN) [below of=CalibN,yshift=-1.5em] {Aktuális képkocka lekérése};

\node[box] (ODN) [below of=GetFramesN,yshift=-1.5em] {Objektum(ok) detektálása};

\draw (CalibN) -- (GetFramesN);
\draw (GetFramesN) -- (ODN);


\node[plain] (LDots) [right of=GetFrames3,xshift=7.75em] {$\ldots$};


\node[box,fill=green!10] (OF12) [below of=OD1,xshift=8.25em,yshift=-2.5em] {Optikai folyam meghatározása};
 
\draw (OD1) |- (OF12);
\draw (OD2) |- (OF12);


\node[box] (OF23) [below of=OD2,xshift=8.25em,yshift=-2.5em] {Optikai folyam meghatározása};
 
\draw (OD2) |- (OF23);
\draw (OD3) |- (OF23);


\node[plain] (OF34) [below of=OD3,xshift=6em,yshift=-2.5em,text width=2em] {$\ldots$};
\draw (OD3) |- (OF34);

\node[plain,below of=ODN,xshift=-6em,yshift=-2.5em,text width=2em] (OFnn) {$\ldots$};
\draw (ODN) |- (OFnn);



\node[box,fill=green!10] (Triangle12) [below of=OF12,yshift=-1.5em] {Háromszögelés};

\draw (OF12) -- (Triangle12);

\node[box] (Triangle23) [below of=OF23,yshift=-1.5em] {Háromszögelés};

\draw (OF23) -- (Triangle23);


\node[plain] (Others) [below of=OD3,xshift=10em,yshift=-8em,text width=2em] {$\vdots$};

\node[box] (Merge) [below of=Triangle12,xshift=8em,yshift=-2.5em] {Összefűzés};

\draw (Triangle12) |- (Merge);
\draw (Triangle23) |- (Merge);
\draw (Others) |- (Merge);


\node[box,fill=green!10] (Contour) [below of=Merge,yshift=-1.5em] {Nézőpontból projekció + kontúr};

\draw (Merge) -- (Contour);



\begin{pgfonlayer}{background}
    \path (Cam1.north west)+(-0.5,0.5) node (a) {};
    \path (OD1.south east)+(+0.5,-0.5) node (b) {};
    \path[rounded corners, draw=black!50, dashed] (a) rectangle (b);
\end{pgfonlayer}

\begin{pgfonlayer}{background}
    \path (Cam2.north west)+(-0.5,0.5) node (a) {};
    \path (OD2.south east)+(+0.5,-0.5) node (b) {};
    \path[rounded corners, draw=black!50, dashed] (a) rectangle (b);
\end{pgfonlayer}

\begin{pgfonlayer}{background}
    \path (Cam3.north west)+(-0.5,0.5) node (a) {};
    \path (OD3.south east)+(+0.5,-0.5) node (b) {};
    \path[rounded corners, draw=black!50, dashed] (a) rectangle (b);
\end{pgfonlayer}


\begin{pgfonlayer}{background}
    \path (CamN.north west)+(-0.5,0.5) node (a) {};
    \path (ODN.south east)+(+0.5,-0.5) node (b) {};
    \path[rounded corners, draw=black!50, dashed] (a) rectangle (b);
\end{pgfonlayer}

\end{tikzpicture}
}

\caption{Optikai folyamok módszere \label{fig:of-method}}
\end{sidewaysfigure}

Gondoljuk meg, hogy a fenti eljárás tetszőleges számú kamera-párra (amelyek nem feltétlen diszjunktak) általánosítható, és az így kapott pontfelhőket, felhasználva, hogy az adatokat az előzetes kalibrációnak köszönhetően egy közös világ-koordinátarendszerben kapjuk meg, ezeket könnyen egyesíthetjük. Ezt a folyamatot mutatja be \aref{fig:of-method}. ábra. A diplomaterv keretében a színezett hátterű lépések készültek el, a több kamerára vonatkozó együttes kezelés nem.

% --------------------------------
\section{Összefoglaló}
% --------------------------------

Ebben a fejezetben bemutattam az alkalmazott keretrendszert, melyre a megoldásomat építettem. Megfogalmaztam a célkitűzésem, miszerint két rögzített kamera által megfigyelt térrészben rekonstruálok egy illetve két mozgó objektumot egy a két kamera közötti szakaszon választott nézőpontból. Rögzítettem a sikerkritériumot, hogy a rekonstruálást akkor tekintem sikeresnek, ha a mozgó objektumok megközelítő kontúrjait sikeresen meghatározom. Végül leírtam az implementálásra kerülő rendszer lépésekre bontott logikáját.